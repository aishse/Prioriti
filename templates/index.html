<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="{{url_for('static',filename='dist/output.css')}}">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

        <!-- DM Serif Display from Google Fonts -->
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&display=swap" rel="stylesheet">

        <style>
         
            .dm-serif { font-family: 'DM Serif Display', serif; }
            input.no-spin::-webkit-outer-spin-button,
            input.no-spin::-webkit-inner-spin-button {
                -webkit-appearance: none;
                margin: 0;
            }

            input.no-spin[type=number] {
                -moz-appearance: textfield;
            }
            
            #settings {
                max-height: 0;
                opacity: 0;
                overflow: hidden;
                padding-top: 0;
                padding-bottom: 0;
                transition: max-height 0.4s ease-in-out, opacity 0.4s ease-in-out, padding 0.4s ease-in-out;
            }
            
            #settings.show {
                max-height: 500px;
                opacity: 1;
                padding-top: 1rem;
                padding-bottom: 1rem;
            }
            
            #settings.hidden {
                display: none;
            }
            
            #settingsIcon {
                transition: transform 0.4s ease-in-out;
            }
            
            /* Ensure settings container doesn't affect layout */
            #settingsContainer {
                position: fixed;
                top: 1rem;
                left: 1rem;
            }
        </style>
        <title>Welcome to Prioriti</title>
</head>
<body class=" bg-[#fadfc0] p-10">
    <!-- =============================================================== -->
    <!--                         SETTINGS PANEL                         -->
    <!-- =============================================================== -->
    <div id="settingsContainer" class="fixed top-4 left-4 w-64" style="z-index: 9999;">
        <button id="settingsToggle" class="w-full flex justify-between items-center p-3 gap-2 rounded-lg shadow-md hover:bg-amber-50 transition-colors ease-in-out">
            <span class="font-semibold text-amber-950">Settings</span>
            <i id="settingsIcon" class="fa-solid fa-chevron-down transition-transform duration-300"></i>
        </button>
        <div id="settings" class="absolute top-full left-0 mt-2 w-full bg-white rounded-lg shadow-md hidden" style="z-index: 9999;">
            <!-- Enter custom times for pomomdoro timer -->
            <div class="w-full p-4">
                <div class="grid grid-cols-2 gap-2 items-center">
                    <label for="workInput" class="text-right pr-2">Work duration:</label>
                    <input id="workInput" class="w-20 text-center border rounded" 
                        type="number" value="{{ settings.work }}">
                    <label for="smallBreakInput" class="text-right pr-2">Small break duration:</label>
                    <input id="smallBreakInput" class="w-20 text-center border rounded no-spin" type="number" value="{{ settings.small_break }}">

                    <label for="longBreakInput" class="text-right pr-2">Long break duration:</label>
                    <input id="longBreakInput" class="w-20 text-center border rounded no-spin" type="number" value="{{ settings.long_break }}">
                </div>

                <div class="flex flex-col gap-2 mt-4">
                    <button id="setCustomDurationsBtn" class="p-2 text-white bg-amber-950 hover:bg-amber-800 transition-colors ease-in-out text-md rounded">Set</button>
                    <button id="resetDefault" class="p-2 text-white bg-amber-950 hover:bg-amber-800 transition-colors ease-in-out text-md rounded">Reset</button>
                </div>
            </div>
        </div>
    </div>
    <div class="flex flex-col gap-3 justify-center items-center">
    <h1 class="text-4xl font-semibold dm-serif">Welcome to Prioriti!</h1>
    <p class="text-xl font-light font-sans">Your task management solution.</p>

   
    <!-- =============================================================== -->
    <!--                       POMODORO TIMER UI                         -->
    <!-- =============================================================== -->
    <div class="flex text-center justify-center text-7xl dm-serif items-center">
    <button id="stateBack" class="p-2 hover:text-amber-800 transition-colors ease-in-out text-black text-2xl rounded"> <i class="fa-solid fa-angle-left"></i></button>

    <input id="minutesInput" class="w-20 text-center border rounded border-none no-spin" type="number" value="25" min="0">
    <span>:</span>
    <input id="secondsInput" class="w-20 text-center border rounded border-none no-spin" type="number" value="00" min="0" max="59">
    <button id="stateForward" class="p-2 hover:text-amber-800 transition-colors ease-in-out text-black text-2xl rounded"> <i class="fa-solid fa-angle-right"></i></button>

    </div>
    <h1 id="stateLabel"></h1>
    
     <!--- Button Row -->
    <div class="flex gap-2"> 
        <button id="toggleBtn" class="p-2 hover:text-amber-800 transition-colors ease-in-out text-black text-2xl rounded"> <i id="toggleIcon" class="fa-solid fa-play"></i></button>

        <button id="resetBtn" class="p-2  text-black hover:text-amber-800 transition-colors ease-in-out text-2xl rounded"> <i class="fa-solid fa-rotate-right"></i></button>
    </div>
    </div>

    <!-- =============================================================== -->
    <!--                       TASK MANAGEMENT UI                        -->
    <!-- =============================================================== -->
    <div class="mt-10 mx-auto bg-white shadow-lg p-6 rounded-lg w-full max-w-xl">

        <h2 class="text-3xl font-bold dm-serif text-amber-950 mb-4">Your Tasks</h2>

        <!-- ADD TASK FORM -->
        <div class="flex flex-col gap-3 mb-4">

            <input id="taskTitle" placeholder="Task name..."
                   class="border p-2 rounded w-full">

            <div class="flex gap-2">
                <select id="prioritySelect" class="border p-2 rounded w-1/2">
                    <option>Low</option>
                    <option>Medium</option>
                    <option>High</option>
                </select>

                <input id="dueDate" type="date" class="border p-2 rounded w-1/2">
            </div>

            <button id="addTaskBtn"
                    style="background-color:#b45309; color:white; padding:8px 16px; border:2px solid #7c2d12; border-radius:6px; width:100%; font-weight:bold;">
                    Add Task
            </button>
        </div>

        <!-- SORTING -->
        <button id="sortPriorityBtn"
                style="background-color:#f59e0b; color:white; padding:8px 16px; border-radius:6px; width:100%; font-weight:bold;">
            Sort by Priority
        </button>

        <!-- TASK LIST -->
        <ul id="taskList" class="space-y-2"></ul>
    </div>
   
</body>


<!-- =============================================================== -->
<!--                         JAVASCRIPT LOGIC                         -->
<!-- =============================================================== -->
<script>

    const minInput = document.getElementById("minutesInput");
    const secInput = document.getElementById("secondsInput");
    const toggleIcon = document.getElementById("toggleIcon");
    const toggleBtn = document.getElementById("toggleBtn");
    const resetBtn = document.getElementById("resetBtn");
    const stateField = document.getElementById("stateLabel");
    const stateBackBtn = document.getElementById("stateBack");
    const stateForwardBtn = document.getElementById("stateForward");
    const resetDefaultBtn = document.getElementById("resetDefault");

    const workInput = document.getElementById("workInput");
    const smallBreakInput = document.getElementById("smallBreakInput");
    const longBreakInput = document.getElementById("longBreakInput");
    const setCustomDurationsBtn = document.getElementById("setCustomDurationsBtn");
    const settingsToggle = document.getElementById("settingsToggle");
    const settingsPanel = document.getElementById("settings");
    const settingsIcon = document.getElementById("settingsIcon");

    async function fetchState() {
        const res = await fetch("/get_state");
        const data = await res.json();
        minInput.value = String(data.minutes).padStart(2, "0");
        secInput.value = String(data.seconds).padStart(2, "0");
        stateField.textContent = data.stateLabel;
        toggleIcon.className = data.running ? "fa-solid fa-pause" : "fa-solid fa-play";
    }

    fetchState();
    setInterval(fetchState, 1000);

    toggleBtn.addEventListener("click", async() => {
        await fetch("/toggle_timer", { method: "POST" });
        fetchState();
    })
    
    resetBtn.addEventListener("click", async () => {
        await fetch("/reset_timer", { method: "POST" });
        const state = await fetch("/get_state").then(res => res.json());
        minInput.value = String(state.minutes).padStart(2, "0");
        secInput.value = String(state.seconds).padStart(2, "0");
        stateField.textContent = state.stateLabel;
        toggleIcon.className = state.running ? "fa-solid fa-pause" : "fa-solid fa-play";
    
    });

    stateForwardBtn.addEventListener("click", async () => {
        await fetch("/next_state", { method: "POST" });
        fetchState();
    });

    stateBackBtn.addEventListener("click", async () => {
        await fetch("/prev_state", { method: "POST" });
        fetchState();
    });

    resetDefaultBtn.addEventListener("click", async () => {
        const response = await fetch("/reset_durations", { method: "POST" });
        const data = await response.json();
        workInput.value = data.work;
        smallBreakInput.value = data.small_break;
        longBreakInput.value = data.long_break;
        fetchState();
    });

    settingsToggle.addEventListener("click", async () => {
        const isHidden = settingsPanel.classList.contains("hidden");
        if (isHidden) {
            
            settingsPanel.classList.remove("hidden");
          
            void settingsPanel.offsetHeight;
            settingsPanel.classList.add("show");
            settingsIcon.style.transform = "rotate(180deg)";
        } else {
        
            settingsPanel.classList.remove("show");
            settingsIcon.style.transform = "rotate(0deg)";
            setTimeout(() => {
                settingsPanel.classList.add("hidden");
            }, 400);
        }
    });
    
    setCustomDurationsBtn.addEventListener("click", async() => {
        const work = workInput.value.trim() !== "" ? parseInt(workInput.value) : null;
        const smallBreak = smallBreakInput.value.trim() !== "" ? parseInt(smallBreakInput.value) : null;
        const longBreak = longBreakInput.value.trim() !== "" ? parseInt(longBreakInput.value) : null;

        // Only send valid numbers (not NaN)
        const payload = {};
        if (work !== null && !isNaN(work) && work > 0) {
            payload.work = work;
        }
        if (smallBreak !== null && !isNaN(smallBreak) && smallBreak > 0) {
            payload.small_break = smallBreak;
        }
        if (longBreak !== null && !isNaN(longBreak) && longBreak > 0) {
            payload.long_break = longBreak;
        }

        await fetch("/update_durations", {
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify(payload)
        });
        fetchState();
    });

    /* ------------------------------------------------------------ */
    /*                        TASK LIST LOGIC                       */
    /* ------------------------------------------------------------ */
    async function loadTasks() {
            const res = await fetch("/tasks");
            const data = await res.json();

            const list = document.getElementById("taskList");
            list.innerHTML = "";

            data.tasks.forEach(t => {
                const li = document.createElement("li");

                const bgColor = t.completed
                    ? "bg-green-200"
                    : t.priority === "High" ? "bg-red-100"
                    : t.priority === "Medium" ? "bg-yellow-100"
                    : "bg-green-100";

                li.className = `p-3 rounded shadow flex justify-between items-center ${bgColor}`;

                /* LEFT SIDE: Task Info */
                const left = document.createElement("div");
                left.innerHTML = `
                    <div class="font-semibold ${t.completed ? 'line-through text-gray-600' : ''}">
                        ${t.title}
                    </div>
                    <div class="text-sm ${t.completed ? 'text-gray-600' : 'text-gray-700'}">
                        Priority: ${t.priority}
                        ${t.due_date ? ` | Due: ${t.due_date}` : ""}
                        ${t.completed ? ` | <span class='text-green-700 font-semibold'>âœ“ Completed</span>` : ""}
                    </div>
                `;

                /* RIGHT SIDE: Action Buttons */
                const right = document.createElement("div");
                right.className = "flex gap-3";

                /* Complete button */
                if (!t.completed) {
                    const completeBtn = document.createElement("button");
                    completeBtn.className = "text-green-700 hover:text-green-900";
                    completeBtn.innerHTML = "<i class='fa-solid fa-check'></i>";
                    completeBtn.onclick = async () => {
                        await fetch("/complete_task", {
                            method: "POST",
                            headers: {"Content-Type": "application/json"},
                            body: JSON.stringify({ title: t.title })
                        });
                        loadTasks();
                    };
                    right.appendChild(completeBtn);
                }

                /* Delete button */
                const deleteBtn = document.createElement("button");
                deleteBtn.className = "text-red-700 hover:text-red-900";
                deleteBtn.innerHTML = "<i class='fa-solid fa-trash'></i>";
                deleteBtn.onclick = async () => {
                    await fetch("/delete_task", {
                        method: "POST",
                        headers: {"Content-Type": "application/json"},
                        body: JSON.stringify({ title: t.title })
                    });
                    loadTasks();
                };
                right.appendChild(deleteBtn);

                li.appendChild(left);
                li.appendChild(right);
                list.appendChild(li);
            });
        }

        /* Add Task */
        document.getElementById("addTaskBtn").addEventListener("click", async () => {
            const title = taskTitle.value.trim();
            const priority = prioritySelect.value;
            const due = dueDate.value;

            if (!title) return;

            await fetch("/add_task", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({
                    title,
                    priority,
                    due_date: due
                })
            });

            taskTitle.value = "";
            dueDate.value = "";
            loadTasks();
        });

        /* Sort Tasks by Priority */
        document.getElementById("sortPriorityBtn").addEventListener("click", async () => {
            await fetch("/sort_priority");
            loadTasks();
        });

        loadTasks();

</script>

</html>
